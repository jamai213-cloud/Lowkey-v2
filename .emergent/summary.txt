<analysis>

<original_problem_statement>
The user wants to build a faithful, production-ready rebuild of an existing application called Lowkey from scratch. The project is a complex, multi-feature social application.

**LATEST PRODUCT REQUIREMENTS (from user messages):**
- **UI Freeze**: **Do not change the design do not change the ui keep the app exactly the same no changes to Ui . Stop immediately if requests compromises the UI**. This is a strict and repeated instruction.
- **Profile System**:
    - A detailed profile form, similar to FabSwingers, with many personal details and an extensive kinks checklist.
    - Direct profile picture and gallery photo upload from the user's device (phone gallery/camera), not via URL. Uploads should support captions.
    - Ability to set photo privacy (Public vs. Friends).
    - Ability to delete uploaded photos.
- **Social & Monetization**:
    - A tipping/donation system for users to send money (£ GBP) to creators. The platform takes a 20% cut.
    - Communities with 24-hour expiring invite codes.
    - A Notice Board for the Founder to post updates to all users.
    - New messages from non-friends must go to a notification area (bell) where the user can accept the chat (moves to inbox) or delete the request.
    - Option for users to leave comments anonymously.
- **Founder Controls**: The Founder () needs the ability to remove users, reset their passwords, and force them to log out from an admin dashboard.
- **Radio**: A list of specific, working UK-based urban/London radio stations. The UI should be a tile-based radio dial design that matches the existing app aesthetic.
- **Music**: A functional music search page that works like Spotify/iTunes, allowing users to search for any artist or song.
- **Games**: The games on the games page must have functional controls that work on mobile/touch devices.
- **General**:
    - All currency must be in Pounds (£), not Dollars ($).
    - All alerts (messages, friend requests, notices, etc.) should have notification sounds, with a Quiet Mode toggle to mute them.
</original_problem_statement>

**User's preferred language**: English

**what currently exists?**
The application is a feature-rich Next.js app with a monolithic MongoDB backend. Significant progress has been made, and many of the user's latest requests have been implemented.
- **Backend**: The  monolith now includes endpoints for a detailed profile, direct file uploads, creator tipping, extended Founder controls (user removal/reset), a new music search proxy to the iTunes API, and updated radio station data.
- **Frontend**:
    - **Profile**: A new  page exists with a comprehensive, multi-tabbed form for personal details and kinks. The main profile page has a Send Tip button with a functional modal that calculates the platform fee. The photo upload component has been changed to a direct file input.
    - **Radio**: The UI has been completely redesigned into a tile-based radio dial layout.
    - **Music**: The UI has been rebuilt with a Spotify-like search bar and results display that pulls data from the iTunes API.
    - **Games**: Basic touch controls (swipe gestures) have been added as an overlay to the Snake and Pac-Man games.
    - **Founder Dashboard**: The dashboard now includes buttons to Reset Password, Force Logout, and Remove User for each member.
    - **Wallet**: The currency symbol has been updated from  to .
- **Authentication**: The  endpoint remains critical for setting up the Founder account on new deployments.

**Last working item**:
- **Last item agent was working on**: The agent was attempting to fix the radio streams. The user reported that many of the stations were not working. The agent tried to use the  tool to find new, working stream URLs for UK urban radio stations.
- **Status**: BLOCKED
- **Agent Testing Done**: N
- **Which testing method agent to use?**: Manual testing by curl / python -c. The agent needs to find valid streaming URLs (e.g., ,  links) and test them with  to see if they return audio data before updating them in the code. Web search is not sufficient.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
-   Issue 1: Find and implement working UK urban radio station streams (P0)
-   Issue 2: Music search is not working as expected for the user (P1)
-   Issue 3: Games are not fully functional (P2)
-   Issue 4: User Login/Access on Deployed Environments (P2)

**Issues Detail**:
-   **Issue 1: Find and implement working UK urban radio station streams**
    -   **Attempted fixes**: The agent last used  to find URLs, but this tool provided website links, not the direct technical stream URLs required by the audio player.
    -   **Next debug checklist**:
        1.  Use  with more technical queries like  or .
        2.  Manually inspect the HTML/network traffic of the radio station websites to find the stream source.
        3.  Once a potential URL is found, use  to check the headers. A content-type of  or similar is a good sign.
        4.  Update the list in  with verified, working URLs.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a direct user request. Fixing it will make the Radio feature functional and fulfill the user's requirement.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend (by visiting the radio page and trying to play stations).
    -   **Blocked on other issue**: No. Blocked on finding valid stream URLs.

-   **Issue 2: Music search is not working as expected for the user**
    -   **Attempted fixes**: The agent implemented a new backend endpoint () using the public iTunes Search API and rebuilt the frontend UI. The agent's own  test for drake was successful. However, the user reported Music can’t find artist. No further debugging was done.
    -   **Next debug checklist**:
        1.  Check the frontend code in  to ensure the search term is being correctly passed to the  endpoint.
        2.  Check browser console logs for any errors when performing a search on the music page.
        3.  Add more robust logging to the  endpoint in  to see what search terms are being received from the frontend.
        4.  Test with a variety of artist names to see if the issue is specific to certain queries.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a core feature request. Fixing it will provide the Spotify/iTunes-like experience the user wants.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Both.
    -   **Blocked on other issue**: No.

-   **Issue 3: Games are not fully functional**
    -   **Attempted fixes**: The agent added swipe-based touch controls as an overlay in . This was a good attempt to add functionality without changing the UI.
    -   **Next debug checklist**:
        1.  The implementation needs to be tested to see if the swipe events correctly translate to game movements (up, down, left, right).
        2.  The implementation may not be robust. Consider adding on-screen D-pad buttons that are only visible when a game is active, which is more reliable than swipes (this may violate the no UI change rule, so it should be proposed to the user first).
    -   **Why fix this issue and what will be achieved with the fix?**: The user explicitly stated the games are non functional. Making them playable on mobile is required.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Frontend.
    -   **Blocked on other issue**: No.

-   **Issue 4: User Login/Access on Deployed Environments**
    -   **Attempted fixes**: This is a recurring communication issue. The agent has repeatedly and successfully used the  endpoint to grant the  account full Founder/Admin permissions.
    -   **Next debug checklist**: This is not a code issue. The next agent must be prepared to pre-emptively remind the user of the process: after any new deployment, they **must** visit  before attempting to log in.
    -   **Why fix this issue and what will be achieved with the fix?**: Prevents user frustration and allows them to test new features.
    -   **Status**: RESOLVED (Code-wise), USER VERIFICATION PENDING (Process-wise)
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: N/A.
    -   **Blocked on other issue**: No.

**In progress Task List**:
None. The active work item is a blocked issue.

**Upcoming and Future Tasks**
- **Upcoming Tasks (from user requests):**
    - **(P1) Implement Non-Friend Message Request Flow**: Create the UI in the bell notifications area for accepting/declining new message requests. The backend logic exists but the frontend flow needs to be built and verified.
    - **(P2) Implement Anonymous Comments**: Add a checkbox or toggle on comment input fields to allow users to post anonymously. This will require backend and frontend changes.
    - **(P3) Implement Photo Filters**: User requested Edit photos with filters etc. This was acknowledged but never started. A simple implementation could use CSS filters (). This should be scoped and planned.

- **Future Tasks (Technical Debt):**
    - **(P0) Refactor API Monolith**: The  file is now dangerously large (well over 2000 lines). It MUST be broken down into smaller, feature-specific files (e.g., , , ) to ensure maintainability and reduce risk.

**Completed work in this session**
- **Radio**:
    - Replaced the entire radio page with a new tile-based dial design ().
    - Updated the list of radio stations in  multiple times based on user feedback.
- **Music**:
    - Created a  endpoint in  that uses the iTunes Search API.
    - Rebuilt the music page () with a modern search interface.
- **Profile & Photos**:
    - Created a new comprehensive profile editing page () with a FabSwingers-style form, including a large, multi-category kink checklist.
    - Implemented direct file upload for photos (no URL input) on the edit page.
    - Added backend endpoints for saving detailed profile info and handling file uploads.
- **Founder & Admin**:
    - Fixed the Founder login/permissions by using the  endpoint.
    - Added backend endpoints for Remove User, Reset Password, and Force Logout.
    - Updated the Founder Dashboard UI () with buttons to trigger these new actions.
- **Monetization & Social**:
    - Implemented a Send Tip feature on creator profiles with a detailed modal showing amounts in £ and the 20% platform fee calculation (, ).
    - Implemented 24-hour expiration for Community invite codes.
- **General Fixes**:
    - Fixed the search page to show all users by default.
    - Changed currency symbols from  to  in the Wallet page.
    - Added basic touch/swipe controls to the Snake and Pac-Man games.
    - Restricted Notices posting to the Founder account.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Music search usability**
    -   The user reported Music can’t find artist after the new feature was built. The agent verified the API works with a  test but did not debug the issue from the user's perspective.
    -   **Debug checklist**: See Pending/In progress Issue list - Issue 2.
    -   **Why to solve this issue and what will be achieved with this?**: It's a key requested feature that is currently not meeting user expectations.
    -   **Should Test frontend/backend/both after fix**: Both.
    -   **Is recurring issue?**: N

-   **Issue 2: Photo Filters**
    -   The user requested to Edit photos with filters etc. This was acknowledged by the agent but never implemented.
    -   **Debug checklist**:
        1.  Plan a simple implementation, likely using CSS filters.
        2.  Add a UI element (e.g., a small modal with filter buttons) to the photo gallery or upload process.
        3.  Save the selected filter class/style to the  in the database.
        4.  Apply the saved filter when rendering the image.
    -   **Why to solve this issue and what will be achieved with this?**: Fulfills a direct user request for profile customization.
    -   **Should Test frontend/backend/both after fix**: Frontend.
    -   **Is recurring issue?**: N

-   **Issue 3: Anonymous Comments**
    -   The user requested the choice to leave anonymous or not on comments. This was acknowledged but never implemented.
    -   **Debug checklist**:
        1.  Add a boolean field like  to the comment schema.
        2.  Add a checkbox to the comment input UI.
        3.  Update the comment submission endpoint to handle this new field.
        4.  Update the comment display logic to show Anonymous instead of the username if the flag is true.
    -   **Why to solve this issue and what will be achieved with this?**: Fulfills a direct user request for social interaction privacy.
    -   **Should Test frontend/backend/both after fix**: Both.
    -   **Is recurring issue?**: N

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: User () being unable to log in or not having the correct Founder/Admin permissions after a new deployment.
-   **Recurrence count**: High (has occurred in nearly every major interaction).
-   **Status**: RESOLVED (from a code perspective). This is a process issue. The solution is to have the user visit the  endpoint after each deployment. The next agent must be proactive in communicating this.

**Code Architecture**


**Key Technical Concepts**
- **Framework**: Next.js 14 (App Router)
- **Database**: MongoDB
- **Styling**: TailwindCSS, shadcn/ui
- **Authentication**: Custom JWT implementation.
- **API**: Monolithic API route (), now extremely large and complex.
- **3rd Party Integration**: iTunes Search API (for music search, no key required).
- **File Handling**: Direct file uploads for profile pictures/gallery items using .
- **Security**:  used for the new password reset functionality.

**key DB schema**
-   **User**: { ..., role, isCreator, isFounder, verificationTier, subscriptionPrice, quietMode, galleryPrivacy: 'public'|'friends', **profileDetails**: { aboutMe, lookingFor, age, gender, sexuality, status, physical: {...}, lifestyle: {...}, location: {...}, interests: {...}, kinks: {...} } }
-   **GalleryItem**: { userId, mediaUrl, **caption**: string, privacy: 'public'|'friends' }
-   **Tip**: { tipperId, receiverId, amount, message, platformFee, createdAt }
-   **Community**: { name, adminId, inviteCode, **inviteCodeExpiresAt**: Date }

**All files of reference**
-   : **MOST CRITICAL**. All backend logic is here. Heavily modified and very high-risk to edit.
-   : **New**. Contains the large, complex profile editing form.
-   : Heavily modified to include the Send Tip feature and the link to the new edit page.
-   : Completely overwritten with the new UI. Its functionality depends on the stream URLs in .
-   : Completely overwritten with the new search UI.
-   : Modified to include new user management buttons and API calls.
-   : Modified to include touch control logic.

**Areas that need refactoring**
-   The monolithic  is the single biggest technical debt and risk in the project. It urgently needs to be broken down into separate files by domain (auth, users, profile, communities, etc.). Any future work will be slowed down and made riskier by this file.

**key api endpoints**
-   : (New) Searches the iTunes API for music.
-   : (New) POST/PUT endpoint for the detailed profile form.
-   : (New) POST endpoint for direct file uploads.
-   : (New) POST endpoint to process creator tips.
-   : (New) POST endpoint to delete a user.
-   : (New) POST endpoint to reset a user's password.
-   : (New) POST endpoint to invalidate a user's tokens.

**Critical Info for New Agent**
-   **UI FREEZE IS MANDATORY**: The user has been extremely clear: **Do not change the design do not change the ui keep the app exactly the same no changes to Ui**. You must prioritize functionality fixes and additions that do not alter the existing visual layout. Propose any potential UI changes to the user for approval before implementing.
-   **START WITH THE BLOCKED TASK**: Your first priority is to unblock the radio station issue. The current approach of using  is not working. You need to find a way to get technical stream URLs.
-   **ADDRESS USER-REPORTED BUGS NEXT**: After the radio, address the music search issue and verify the game controls. The user has reported these as not working, so they are high priority.
-   **FOUNDER LOGIN PROCESS**: Be prepared for the user to report login issues. Proactively remind them to visit the  endpoint after you inform them a new version is ready for review.
-   **MONOLITH RISK**: Be extremely cautious when editing . It is fragile. Consider proposing the refactoring task to the user to improve stability for future development.

**documents created in this job**
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **Request:** Fix non-functional games, find working UK radio streams (keep Capital Xtra), change  to  in Wallet. **Crucially, ordered NO MORE UI/DESIGN CHANGES.** (IN PROGRESS - Wallet done, Games attempted, Radio Blocked)
2.  **Request:** Resume (User prompt to continue after agent's web search). (DONE)
3.  **Request:** Direct photo upload from phone (no URL), add captions, add a donation/tip feature. (DONE)
4.  **Request:** Proceed (User prompt to continue). (DONE)
5.  **Request:** Longer kink form, profile pic upload, fix music search, add Founder powers (remove/reset users), add notification sounds for all actions, ensure currency is £, change message flow for non-friends, allow anonymous comments, and a new list of radio stations. (MOSTLY DONE - music fix, message flow, anon comments are pending)
6.  **Request:** A detailed FabSwingers-style profile form, photo privacy, photo deletion, photo filters, and a new list of radio stations with a radio dial UI. (MOSTLY DONE - photo filters pending)
7.  **Complaint/Request:** Radio not working, music setup is wrong, Founder account has no control. (DONE)
8.  **Request:** Revert UI changes, implement 24-hr community codes, define Notice Board purpose, fix text overflow, and continue with previous tasks (search/radio/music). (DONE)

**Project Health Check:**
-   **Broken**: The Radio feature is currently broken as most stream URLs are invalid.
-   **Mocked**: Payment processing for tips and subscriptions is still placeholder logic; no real payment gateway is integrated.

**3rd Party Integrations**
-   **iTunes Search API**: Used for the music search feature. Publicly accessible, does not require an API key.
-   **Resend**: For Forgot Password emails. Still requires a user-provided .

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None.
-   **Known regressions**: Radio functionality is currently degraded due to broken stream links.

**Credentials to test flow:**
-   **Founder/Admin**:
    -   **Email**: 
    -   **Password**: 
-   **Important**: The  endpoint must be hit after any database reset or on a new environment to ensure this account has the correct permissions.

**What agent forgot to execute**
-   **Photo Filters**: Requested by the user but never implemented.
-   **Anonymous Comments**: Requested by the user but never implemented.
-   **Full verification of several features**:
    -   **Music Search**: The agent did not debug why it was failing for the user.
    -   **Notification Sounds**: A  file was created, but there's no evidence the sounds were integrated into all required frontend components (new messages, friend requests, notices etc.).
    -   **Non-Friend Message Flow**: The UI for the bell notification review (Accept/Decline) was likely not fully implemented or tested.

</analysis>
